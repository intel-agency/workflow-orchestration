name: orchestrator-agent

on:
  issues:
    types: [opened, edited, reopened, assigned]
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  pull_request_review:
    types: [submitted, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  # workflow_run:
  #   types: [completed, requested]

jobs:
  orchestrate:
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Assemble orchestrator prompt
        shell: bash
        env:
          EVENT_JSON: ${{ toJson(github.event) }}
        run: |
          # Build the structured event context + JSON blob to inject
          EVENT_BLOCK=$(cat <<'BLOCK_END'
          Event Name: ${{ github.event_name }}
          Action: ${{ github.event.action }}
          Actor: ${{ github.actor }}
          Repository: ${{ github.repository }}
          Ref: ${{ github.ref }}
          SHA: ${{ github.sha }}
          BLOCK_END
          )

          # Assemble prompt in the workspace so it's available inside the devcontainer
          PROMPT_TEMPLATE=".github/workflows/prompts/orchestrator-agent-prompt.md"
          ASSEMBLED_PROMPT=".assembled-orchestrator-prompt.md"

          # Replace __EVENT_DATA__ placeholder with structured context + full event JSON
          {
            sed '/__EVENT_DATA__/,$ d' "$PROMPT_TEMPLATE"
            echo "$EVENT_BLOCK"
            echo ""
            echo '```json'
            echo "$EVENT_JSON"
            echo '```'
          } > "$ASSEMBLED_PROMPT"

          echo "ORCHESTRATOR_PROMPT_PATH=$ASSEMBLED_PROMPT" >> "$GITHUB_ENV"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run orchestrator agent in devcontainer
        uses: devcontainers/ci@v0.3
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: never
          env: |
            ZHIPU_API_KEY
            GITHUB_TOKEN
            ORCHESTRATOR_PROMPT_PATH
          runCmd: |
            opencode \
              --model zai-coding-plan/glm-5 \
              --agent Orchestrator \
              --prompt "$ORCHESTRATOR_PROMPT_PATH"



name: Agent Runner

on:
  pull_request:
    types: [opened, synchronize]
  issues:
    types: [opened]
  create: # Trigger on new branch/repo creation

jobs:
  run-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # Allow agent to commit code
      pull-requests: write # Allow agent to comment/approve PRs
      issues: write        # Allow agent to comment on issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Prepare the Payload
      # We dump the GitHub event context to a JSON file.
      # This is safer than passing a massive JSON string as a CLI argument.
      - name: Save Event Payload
        run: |
          echo '${{ toJson(github.event) }}' > event_payload.json
          echo "Triggered by: ${{ github.event_name }}"

      # 2. Run Agent in DevContainer
      # uses: devcontainers/ci allows us to execute commands INSIDE the container
      - name: Execute Agent in DevContainer
        uses: devcontainers/ci@v0.3
        env:
          # Pass necessary API keys to the container
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Path to the folder containing .devcontainer (usually root)
          subFolder: "."
          
          # (Optional) Speed up builds by caching the image
          imageName: ghcr.io/${{ github.repository }}/devcontainer
          cacheFrom: ghcr.io/${{ github.repository }}/devcontainer
          push: never # specific to your caching strategy
          
          # THE COMMAND TO RUN INSIDE THE CONTAINER
          # We pass the event name and the path to the payload file
          runCmd: |
            echo "Running Agent for trigger: ${{ github.event_name }}"
            
            # Example CLI command (Adjust flags to your specific agent's syntax)
            opencode run \
              --trigger "${{ github.event_name }}" \
              --payload-file event_payload.json \
              --prompt "Act on this ${{ github.event_name }} event based on the payload data."
