name: orchestrator-agent

on:
  issues:
    types: [opened, edited, reopened, assigned]
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  pull_request_review:
    types: [submitted, edited]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
  # workflow_run:
  #   types: [completed, requested]

jobs:
  orchestrate:
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Assemble orchestrator prompt
        shell: bash
        env:
          EVENT_JSON: ${{ toJson(github.event) }}
        run: |
          # Build the structured event context + JSON blob to inject
          EVENT_BLOCK=$(cat <<'BLOCK_END'
          Event Name: ${{ github.event_name }}
          Action: ${{ github.event.action }}
          Actor: ${{ github.actor }}
          Repository: ${{ github.repository }}
          Ref: ${{ github.ref }}
          SHA: ${{ github.sha }}
          BLOCK_END
          )

          # Assemble prompt in the workspace so it's available inside the devcontainer
          PROMPT_TEMPLATE=".github/workflows/prompts/orchestrator-agent-prompt.md"
          ASSEMBLED_PROMPT=".assembled-orchestrator-prompt.md"

          # Replace __EVENT_DATA__ placeholder with structured context + full event JSON
          {
            sed '/__EVENT_DATA__/,$ d' "$PROMPT_TEMPLATE"
            echo "$EVENT_BLOCK"
            echo ""
            echo '```json'
            echo "$EVENT_JSON"
            echo '```'
          } > "$ASSEMBLED_PROMPT"

          echo "ORCHESTRATOR_PROMPT_PATH=$ASSEMBLED_PROMPT" >> "$GITHUB_ENV"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Start devcontainer
        run: |
          devcontainer up \
            --workspace-folder . \
            --config .github/.devcontainer/devcontainer.json

      - name: Execute orchestrator agent in devcontainer
        env:
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          devcontainer exec \
            --workspace-folder . \
            --config .github/.devcontainer/devcontainer.json \
            --remote-env ZHIPU_API_KEY="$ZHIPU_API_KEY" \
            --remote-env GITHUB_TOKEN="$GITHUB_TOKEN" \
            --remote-env ORCHESTRATOR_PROMPT_PATH="$ORCHESTRATOR_PROMPT_PATH" \
            -- bash -c '
              set -euo pipefail

              if [[ -z "${ZHIPU_API_KEY:-}" ]]; then
                echo "::error::ZHIPU_API_KEY is not set"
                exit 1
              fi

              if [[ -z "${ORCHESTRATOR_PROMPT_PATH:-}" ]]; then
                echo "::error::ORCHESTRATOR_PROMPT_PATH is not set"
                exit 1
              fi

              if [[ ! -s "${ORCHESTRATOR_PROMPT_PATH}" ]]; then
                echo "::error::Prompt file not found or empty: ${ORCHESTRATOR_PROMPT_PATH}"
                exit 1
              fi

              ORCHESTRATOR_PROMPT_CONTENT="$(cat "${ORCHESTRATOR_PROMPT_PATH}")"

              echo "Starting opencode at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
              set +e
              stdbuf -oL -eL timeout 10m opencode run \
                --model zai-coding-plan/glm-5 \
                --agent orchestrator \
                --print-logs \
                --log-level DEBUG \
                "${ORCHESTRATOR_PROMPT_CONTENT}" 2>&1
              OPCODE_EXIT_CODE=$?
              set -e

              if [[ ${OPCODE_EXIT_CODE} -eq 124 ]]; then
                echo "::warning::opencode run timed out after 10 minutes; continuing workflow"
                exit 0
              fi

              exit ${OPCODE_EXIT_CODE}
            '
